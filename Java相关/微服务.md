# CAP理论

- **一致性Consistency**：所有节点在同一时间具有相同数据
  - 强一致性：更新过后的数据能被后续的访问看到。
  - 弱一致性：能容忍更新后后续部分或者全部访问不到。
  - 最终一致性：经过一段时间后要求能访问到更新后数据。
- **可用性Availability**：服务一直可用且能在正常响应时间内给与反馈。
- **分隔容忍Partition**：系统中网络/节点故障时仍能对外提供CA服务。
- 三选二
  - C-A: 一致性要求高时可用性降低，数据在节点间的同步需耗时。
  - A-C: 造成一致性降级。
  - C&A - P: 单点服务不能保证分隔容忍



# 分布式事务

解决问题：非单机环境(分库分表)下事务操作的正确性，尽力保证事务的ACID特性。

- AD原子性持久性：严格遵循
- I隔离性：并行事务之间不可影响；事务中间结果可见性允许适当放宽
- C一致性：事务过程中的一致性适当放宽；事务完成后的一致性严格遵守



参与角色：

- 应用程序： AP - 事务发起者
- 资源管理器：RM
- 事务管理器：TM

- **事务发起者，资源、资源管理器和事务协调者分别位于分布式系统不同节点，保障分布式场景下数据操作的正确执行。**



## 1. 两阶段提交/XA

1. prepare: 所有RM锁住需要的资源并准备执行事务，参与者Ready时向TM报告准备就绪。
2. commit/rollback: TM确认所有RM ready后向所有参与者发送commit命令。

- 若任何一个RM prepare失败，则TM通知本轮参与所有prepare的RM回滚。

![v2-90e76ee46f1be7c1aaa8643a425683b0_720w](D:\Huawei Share\Screenshot\v2-90e76ee46f1be7c1aaa8643a425683b0_720w.jpg)



# 一致性Hash

普通Hash算法不足：rehash时造成节点迁移。

- eg. 除留余数法初始4，扩容时需数据迁移，影响较大。



环形Hash空间

- 一致性Hash算法节点槽通常为无符号int范围0~2^32-1的数字空间，首尾相连形成闭环。

映射服务节点

- 将各个服务器使用Hash算法映射到换空间上的一个槽
- 通过虚拟节点保障数据分布平衡性。

映射数据

- 将对象通过Hash算法映射到环空间的槽，然后从数据所在位置顺时针环走直最邻近服务器，进行相应存储处理。

服务器删减

- 若某台服务器(A)宕机，将A节点数据顺时针迁移到其最邻近的一个服务器节点
- 若新增某台服务器X，将X映射到环中，设其逆时针临近服务器为Y，将Y~X中数据迁移到X。

**优化策略 - 虚拟节点**

- 为保障平衡性，避免服务器节点较少时大量数据集中到某吸额服务器节点中。 **对每个服务节点计算多个哈希映射并在相应槽位置放置一个该服务节点。**
  - 在ip / 主机名 后添加编号 #&*....，由此计算Hash值

<img src="D:\Huawei Share\Screenshot\v2-5d9cdea01cb4b44162aa41980345e8ac_720w.jpg" alt="v2-5d9cdea01cb4b44162aa41980345e8ac_720w" style="zoom:50%;" />